# 도커

### 도커 이미지

- 도커 이미지 뜻?

  - 컨테이너를 만들기 위해 필요한 설정이나 종속성들을 갖고 있는 소프트웨어 페키지

- 도커 허브에 이미 있는 것들을 가져와서 사용하거나, 직접 도커 이미지를 만들거나, 도커 이미지를 도커 허브에 공유할 수도 있다.

- 도커 이미지를 이용해서 도커 컨테이너 생성
  `docker create <이미지 이름>`

### 도커 이미지 생성하는 순서

1. 도커 파일

- 도커 이미지를 만들기 위한 설정 파일. 컨테이너 행동 설정

2. 도커 클라이언트

- 도커 파일에 있는 명령들이 도커 클라이언트에 전달

3. 도커 서버

- 도터 클라이언트에 전달된 작업들을 하는 곳

4. 이미지 생성

### 도커 파일 만드는 순서

1. 베이스 이미지를 명시 (파일 스냅샷)
2. 추가적으로 필요한 파일을 다운 받기 위한 몇 가지 명령어를 명시 (파일 스냅샷)
3. 컨테이너 시작 시 실행될 명령어를 명시 (시작 시 실행될 명령어에 해당)

시작 시 실행할 명령어 = run <이미지 이름>
파일 스냅샷(베이스 이미지 + 추가적으로 필요한 파일들) = 해당 파일

### 베이스 이미지란?

- 베이스 이미지는 이미지의 기반이 되는 부분
- 도커 이미지는 여러개의 레이어들로 되어 있다.
- 레이어는 중간 단계의 이미지
- 이미지(레이어, 레이어, 베이스이미지[쉽게 생각해서 OS 라고 생각하기])
  - 레이어들이 작동할 기반 이미지(OS 등등...)
- 레이어를 추가하면 이미지에 추가가 되며, 이를 레이어 케싱이라고 한다.

```dockerfile
# 베이스 이미지를 명시해준다.
# 이미지 생성시 기반이 되는 이미지 레이어
# <이미지 이름>:<테그> 형식으로 작성 ex)ubuntu:14.04

FROM baseImage

# 추가적으로 필요한 파일들을 다운로드 받는다.
# RUN - 도커 이미지가 생성되기 전에 수행할 쉘 명령어
RUN commnad

# 컨테이너 시작 시 실행 될 명령어를 명시해준다.
# 실행할 실행 파일 또는 쉘 스크립트
# CMD 는 dockerfile 안에 1회만 사용 가능
CMD ["executable"]
```

<!-- 초 간단 hello 출력용 도커 파일 만들기 -->

```dockerfile
FROM alpine

RUN command

CMD ["echo", "hello"]
```

### 도커 이미지 만들기

완성된 도커 파일로 어떻게 이미지를 생성하나?
도커 파일 -> 도커 클라이언트 -> 도커 서버 -> 이미지
도커 파일에 입력된 것들이 도커 클라이언트에 전달되어서 도커 서버가 인식하게 하여야한다.

- `docker build ./`

### build 과정

- 이미지 확인 및 불러오기
- 임시 컨테이너를 하드디스크에 커널에 생성 ( 하드디스크에 파일 시스템 스냅샷 추가)
- 임시 컨테이너 안에 시작시 실행할 명령어를 넣어줌
- 파일 시스템을 하드디스크에 넣어줌
- 임시컨테이너를 -> 원하는 이미지로 생성 (시작시 실행할 명령어와 파일 스냅숏 존재)

과정 집약

1. 베이스 이미지에 다른 종속성이나 새로운 커맨드를 추가할 때는 임시 컨테이너를 만든 후 그 컨테이너를 토대로 새로운 이미지를 만든다. -> 그리고 임시 컨테이너는 지운다.
   (환경설정을 규격화하기 때문에 임시컨테이너를 만들어서 새로운 이미지를 만드는 것이다!?)

### 이미지 실행 방법

`docker run <이미지의 sha256 값 앞쪽만>`

### 도커 파일 작성

- 개발 환경의 도커 파일, 운영 운영 환경의 도커 파일 두 개 필요
- dockerfile.dev

```dockerfile
FROM node:16-alpine

# 리액트관련 파일들이 담길 경로
WORKDIR /user/src/app

# package.json 파일을 현재 dockerfile이 있는 곳에서 WORKDIR 에 복사한다.
COPY package.json ./

RUN npm install

# 전체 directory에 있는 파일들을 그대로 workdir 에 복사
COPY ./ ./

CMD "npm", "run", "start"
```

### 포트 맵핑

- 컨테이너 상의 포트 번호와 컴퓨터 자체의 포트 번호를 연결해야함
- `docker run -p 3000:3000 <이미지 주소>`

### ec2로 도커 설치 미치 설행

1. ec2 인스턴스 연결
2. ssh 클라언트 방식 / 그냥 연결 방식

```
sudo apt-get update
sudo apt-get install \
  ca-certificates \
  curl \
  gnupg \
  lsb-release
```

https://velog.io/@ssssujini99/Docker-%EB%8F%84%EC%BB%A4%EB%9E%80-Docker-GitHub-action%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EC%9E%90%EB%8F%99%EB%B0%B0%ED%8F%AC-%ED%95%B4%EB%B3%B4%EA%B8%B0

https://github.com/JuJin1324/Docker-starter
